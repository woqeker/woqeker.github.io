<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Welcome</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous" />
    <link href="https://getbootstrap.com/docs/4.0/examples/signin/signin.css" rel="stylesheet"
        integrity="sha384-oOE/3m0LUMPub4kaC09mrdEhIc+e3exm4xOGxAmuFXhBNF4hcg/6MiAXAf5p0P56" crossorigin="anonymous" />
    <style>
        body {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container text-center" id="login-block">
        <div>
            <input type="image" src="/img/line.png" alt="Log in with LINE" style="width: 12rem; height: auto;"
                onclick="LogInWithLine()" onkeydown="LogInWithLine()" />
        </div>
    </div>
    <div class="container" id="authenticated-block">
        <h2 id="welcome" class="form-signin-heading">Hello, </h2>
        <div>
            <button onclick="Logout()">logout</a>
        </div>
    </div>
    <script>
        const { LogInWithLine, Logout } = (() => {
            'use strict';

            const CLIENT_ID = '2004743113';
            const CLIENT_SECRET = [!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+(![]+[])[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([][(!![]+[])[!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()+[])[!+[]+!+[]]+[+[]]+(![]+[])[+[]]+(![]+[])[+!+[]]+([][(!![]+[])[!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()+[])[!+[]+!+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[+!+[]]+[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+([][(!![]+[])[!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()+[])[!+[]+!+[]]+(![]+[])[+!+[]];
            const REDIRECT_URI = 'https://demo.lograr.site/demo.html';
            const SCOPE = 'profile openid';
            const MAX_ACCEPTABLE_DELAY = 30_000;

            const LogInWithLine = () => {
                const AUTHORIZATION_URI = 'https://access.line.me/oauth2/v2.1/authorize';
                localStorage.getItem('noticeFinishInTime') === 'false' || alert(`請在 ${parseInt(MAX_ACCEPTABLE_DELAY / 1000)} 秒內完成登入程序`);
                localStorage.setItem('noticeFinishInTime', 'false');
                getState().then(state => {
                    const PARAMS = Object.freeze([
                        'response_type=code',
                        `client_id=${CLIENT_ID}`,
                        `redirect_uri=${REDIRECT_URI}`,
                        `state=${state}`,
                        `scope=${SCOPE}`,
                    ]);
                    location.href = `${AUTHORIZATION_URI}?${PARAMS.join('&')}`;
                });
            };

            const getHex = buffer => Array.from(new Uint8Array(buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');

            const getDigestHex = async data => getHex(await crypto.subtle.digest(
                'SHA-256', new TextEncoder().encode(data)));

            const getState = async () => {
                const salt = crypto.getRandomValues(new Uint32Array(1))[0];
                return `${salt}`.padStart(10, '0') + await getDigestHex(parseInt((salt + Date.now()) / MAX_ACCEPTABLE_DELAY));
            };

            const verifyState = async state => {
                const salt = parseInt(state.slice(0, 10));
                const expectedDigest = state.slice(10);
                const now = Date.now();
                if ((await getDigestHex(parseInt((salt + now) / MAX_ACCEPTABLE_DELAY))) === expectedDigest) {
                    return true;
                }
                // TODO find a better solution for edge case
                if ((await getDigestHex(parseInt((salt + now) / MAX_ACCEPTABLE_DELAY) - 1)) === expectedDigest) {
                    return true;
                }
                return false;
            };

            const fetchToken = async code => {
                const TOKEN_URI = 'https://api.line.me/oauth2/v2.1/token';
                const PARAMS = Object.freeze({
                    'grant_type': 'authorization_code',
                    code,
                    'redirect_uri': REDIRECT_URI,
                    'client_id': CLIENT_ID,
                    'client_secret': CLIENT_SECRET,
                });

                const body = [];
                for (const p in PARAMS) {
                    body.push(encodeURIComponent(p) + '=' + encodeURIComponent(PARAMS[p]));
                }

                return fetch(TOKEN_URI, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    },
                    body: body.join('&'),
                }).then(
                    res => res.json()
                );
            };

            const getPayload = token => JSON.parse(decodeURIComponent(
                atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/'))
                    .split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                    .join('')
            ));

            const Logout = () => location.reload();

            const init = async () => {
                const urlParams = new URLSearchParams(location.search);
                window.history.replaceState({}, document.title, location.pathname);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                let loginSuccess = false;
                if (code) {
                    if (await verifyState(state)) {
                        const token = await fetchToken(code);
                        if (token) {
                            const idToken = getPayload(token.id_token);
                            document.getElementById('login-block').remove();
                            document.getElementById('welcome').innerText += idToken.name;
                            loginSuccess = true;
                        }
                    }
                }
                if (!loginSuccess) {
                    document.getElementById('authenticated-block').remove();
                }
                document.body.style.display = 'block';
            };

            init();

            return { LogInWithLine, Logout };
        })();
    </script>
</body>

</html>
